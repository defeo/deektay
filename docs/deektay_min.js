"use strict";function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(arr,i){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(arr)))return;var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _createForOfIteratorHelper(o){if(typeof Symbol==="undefined"||o[Symbol.iterator]==null){if(Array.isArray(o)||(o=_unsupportedIterableToArray(o))){var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function e(_e2){throw _e2},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var it,normalCompletion=true,didErr=false,err;return{s:function s(){it=o[Symbol.iterator]()},n:function n(){var step=it.next();normalCompletion=step.done;return step},e:function e(_e3){didErr=true;err=_e3},f:function f(){try{if(!normalCompletion&&it.return!=null)it.return()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}var Deektay=/*#__PURE__*/function(){function Deektay(source,_ref){var _this=this;var _ref$type=_ref.type,type=_ref$type===void 0?"guess":_ref$type,_ref$lang=_ref.lang,lang=_ref$lang===void 0?"fr":_ref$lang,_ref$element=_ref.element,element=_ref$element===void 0?"body":_ref$element;_classCallCheck(this,Deektay);this.lang=Deektay.trans[lang];if(!this.lang)throw new Error("Unknown language "+lang);this.type=type=="guess"?source.endsWith(".json")?"json":source.endsWith(".txt")||source.endsWith(".text")?"txt":new Error("Cannot guess the file type of "+source):type=="txt"||type=="json"?type:new Error("unknown type "+type);if(this.type instanceof Error)throw this.type;this.root=document.querySelector(element);if(!this.root)throw new Error("Cannot find element "+element);this.clips=null;this.errors={words:0,sentences:0};this.current=0;this.xhr=new XMLHttpRequest;this.xhr.open("get",source);this.xhr.responseType=this.type=="txt"?"text":"json";this.xhr.onload=function(e){_this.clips=_this.type=="txt"?_this.parse_text(_this.xhr.response):_this.xhr.response;_this.activate()}}_createClass(Deektay,[{key:"start",value:function start(){this.xhr.send()}},{key:"parse_text",value:function parse_text(text){var data=[];text.split("\n").forEach(function(line){var s=line.split(/:\s+/);if(s.length>1){var sent=s.slice(1).join(": ");if(!s[0].trim()){data[data.length-1].sentence.push(sent)}else{data.push({media:s[0].split(","),sentence:[sent]})}}else{console.warn("Discarded line:",line)}});return data}},{key:"activate",value:function activate(){var _this2=this;this.root.innerHTML=Deektay.main;this.sentences=this.root.querySelector("#sentences");this.check=this.root.querySelector("#check");this.check.innerText=this.capitalize(this.lang.check);this.skip=this.root.querySelector("#skip");this.skip.innerText=this.capitalize(this.lang.skip);this.score=this.root.querySelector("#score");this.controls=this.root.querySelector("#controls");this.check.addEventListener("click",function(){_this2.check.disabled=true;var sntc=document.querySelector(".sentence.active");var answ=sntc.querySelector(".answer");var hint=sntc.querySelector(".hint");var answ_t=answ.innerText;var corr=JSON.parse(answ.dataset.hints).map(function(h){return{hint:h,corr:_this2.check_answer(answ_t,h)}}).reduce(function(a,b){return a.corr.errors<b.corr.errors?a:b});var gen_diff=function gen_diff(tokens,orig){var cur=0;var str="";var _iterator=_createForOfIteratorHelper(tokens),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var t=_step.value;if(t.index>cur)str+=orig.substring(cur,t.index);cur=t.index+t.length;str+="<span class=\"".concat(t.good?"right":"wrong","\">").concat(orig.substring(t.index,cur),"</span>")}}catch(err){_iterator.e(err)}finally{_iterator.f()}return str};var answ_str=gen_diff(corr.corr.a_tokens,answ_t);var hint_str=gen_diff(corr.corr.h_tokens,corr.hint);answ.innerHTML=answ_str;answ.classList.add(corr.corr.errors==0?"right":"wrong");hint.innerHTML=hint_str;hint.classList.add(corr.corr.errors==0?"right":"wrong");_this2.errors.words+=corr.corr.errors;_this2.errors.sentences+=!(corr.corr.errors==0);_this2.render_next()});this.skip.addEventListener("click",function(){_this2.render_next()});this.sentences.addEventListener("keyup",function(e){if(e.target.classList.contains("answer")&&e.target.parentNode.classList.contains("active")){_this2.check.disabled=e.target.innerText.trim()===""}});this.render_next()}},{key:"render_next",value:function render_next(){var act=document.querySelector(".sentence.active");act&&act.classList.remove("active");if(this.current<this.clips.length){var next=this.clips[this.current];this.current++;this.sentences.innerHTML+=Deektay.sentence;var sntc=this.sentences.lastChild;var audio=sntc.querySelector("audio");var _iterator2=_createForOfIteratorHelper(next.media),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var m=_step2.value;audio.innerHTML+="<source src=\"".concat(m,"\">")}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var answer=sntc.querySelector(".answer");answer.dataset.hints=JSON.stringify(next.sentence);var play=sntc.querySelector(".play");play.addEventListener("click",function(){audio.play();answer.focus()});play.dispatchEvent(new Event("click"))}else{this.root.classList.add("done");var _iterator3=_createForOfIteratorHelper(this.clips),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var c=_step3.value;this.score.innerHTML+="<p>".concat(c.sentence[0],"</p>")}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}var err=this.errors.words==0?this.capitalize(this.lang.noerr)+"!":this.errors.words==1?"1 ".concat(this.lang.error):"".concat(this.errors.words," ").concat(this.lang.errors);this.score.innerHTML+="<p class=\"errcount\">".concat(err,"</p>")}window.scrollTo(0,document.body.scrollHeight)}},{key:"check_answer",value:function check_answer(answer,hint){var atok=this.tokenize(answer),htok=this.tokenize(hint);var diff=this.diff(atok.map(function(x){return x.token}),htok.map(function(x){return x.token}));var _iterator4=_createForOfIteratorHelper(diff),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _step4$value=_slicedToArray(_step4.value,2),ai=_step4$value[0],hi=_step4$value[1];atok[ai].good=htok[hi].good=true}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}return{errors:htok.length-diff.length,a_tokens:atok,h_tokens:htok}}},{key:"diff",value:function diff(A,B){var n=A.length+1,m=B.length+1;var tab=new Uint32Array(n*m);for(var i=1;i<n;i++){for(var j=1;j<m;j++){var tl=tab[i-1+n*(j-1)]&~3,l=tab[i+n*(j-1)]&~3,t=tab[i-1+n*j]&~3;if(A[i-1]==B[j-1]){tab[i+n*j]=tl+4|0}else{if(t>l)tab[i+n*j]=t|1;else if(t==l)tab[i+n*j]=t|3;else tab[i+n*j]=l|2}}}var seq=[];for(var _i2=n-1,_j=m-1;_i2>0&&_j>0;){if(tab[_i2+n*_j]&1){_i2--}else if(tab[_i2+n*_j]&2){_j--}else{seq.push([_i2-1,_j-1]);_i2--;_j--}}return seq}},{key:"tokenize",value:function tokenize(sentence){var lower=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var seps=/\s+|([.,;:!?"'\-\(\)\[\]¿¡–—―«»<>‘’…]+)/g;var tokens=[];var ind=0;var match;while((match=seps.exec(sentence))!==null){if(match.index>ind){var tok=this.normalize(sentence.substring(ind,match.index),lower);tokens.push({token:tok,index:ind,length:tok.length})}if(match[1]){tokens.push({token:this.normalize(match[1]),index:match.index,length:match[1].length})}ind=match.index+match[0].length}if(ind<sentence.length){var _tok=this.normalize(sentence.substring(ind,sentence.length),lower);tokens.push({token:_tok,index:ind,length:_tok.length})}return tokens}},{key:"normalize",value:function normalize(token){var lower=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(lower)token=token.toLowerCase();switch(token){case"<<":case"\xAB":case">>":case"\xBB":case"\u201D":case"\u201C":token="\"";break;case"\u2018":case"\u2019":case"'":case"'":token="'";break;case"\u2013":case"\u2014":case"\u2015":token="-";break;case"\u2026":token="...";break;}return token}},{key:"capitalize",value:function capitalize(s){return s.charAt(0).toUpperCase()+s.substring(1,s.length)}}]);return Deektay}();Deektay.main="<div id=\"sentences\"></div>\n<div id=\"score\"></div>\n<div id=\"controls\">\n  <button id=\"check\" disabled=\"true\"></button>\n  <button id=\"skip\"></button>\n</div>";Deektay.sentence="<div class=\"sentence active\">\n  <div>\n    <button class=\"play\">\u25B6</button>\n    <p class=\"hint\"></p>\n    <audio style=\"display:none\"></audio>\n  </div>\n  <p class=\"answer\" contentEditable=\"true\"></p>\n</div>";Deektay.trans={"en":{"skip":"skip","check":"check","error":"error","errors":"errors","noerr":"no errors"},"fr":{"skip":"passer","check":"contr\xF4ler","error":"erreur","errors":"erreurs","noerr":"pas d'erreurs"},"it":{"skip":"passa","check":"controlla","error":"errore","errors":"errori","noerr":"nessun errore"}};

